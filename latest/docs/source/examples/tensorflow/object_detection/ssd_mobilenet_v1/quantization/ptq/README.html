

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Step-by-Step &mdash; Intel® Neural Compressor 3.7.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/custom.css?v=68dfede1" />

  
<script type="text/javascript">
  // Configure TMS settings
  window.wapProfile = 'profile-microsite'; // This is mapped by WAP authorize value
  window.wapLocalCode = 'us-en'; // Dynamically set per localized site, see mapping table for values
  window.wapSection = "neural-compressor"; // WAP team will give you a unique section for your site
  window.wapEnv = 'prod'; // environment to be use in Adobe Tags.
  // Load TMS
  (() => {
        let url = 'https://www.intel.com/content/dam/www/global/wap/main/wap-microsite.js';
        let po = document.createElement('script'); po.type = 'text/javascript'; po.async = true; po.src = url;
        let s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  }) ();
</script>

    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../../index.html" class="icon icon-home">
            Intel® Neural Compressor
          </a>
            <div class="version">
              <a href="../../../../../../../../../versions.html">latest▼</a>
              <p>Click link above to switch version</p>
            </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../installation_guide.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../examples_readme.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../api-doc/apis.html">APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../legal_information.html">Legal Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../SECURITY.html">Security Policy</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/neural-compressor">Repo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../../index.html">Intel® Neural Compressor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Step-by-Step</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../../_sources/docs/source/examples/tensorflow/object_detection/ssd_mobilenet_v1/quantization/ptq/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="step-by-step">
<h1>Step-by-Step<a class="headerlink" href="#step-by-step" title="Link to this heading"></a></h1>
<p>This document is used to list steps of reproducing TensorFlow Object Detection models tuning results. This example can run on Intel CPUs and GPUs.</p>
</section>
<section id="prerequisite">
<h1>Prerequisite<a class="headerlink" href="#prerequisite" title="Link to this heading"></a></h1>
<section id="environment">
<h2>1. Environment<a class="headerlink" href="#environment" title="Link to this heading"></a></h2>
<p>Recommend python 3.6 or higher version.</p>
<section id="install-intel-neural-compressor">
<h3>Install Intel® Neural Compressor<a class="headerlink" href="#install-intel-neural-compressor" title="Link to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>neural-compressor
</pre></div>
</div>
</section>
<section id="install-intel-tensorflow">
<h3>Install Intel Tensorflow<a class="headerlink" href="#install-intel-tensorflow" title="Link to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>intel-tensorflow
</pre></div>
</div>
<blockquote>
<div><p>Note: Validated TensorFlow <a class="reference external" href="/docs/source/installation_guide.html#validated-software-environment">Version</a>.</p>
</div></blockquote>
</section>
<section id="installation-dependency-packages">
<h3>Installation Dependency packages<a class="headerlink" href="#installation-dependency-packages" title="Link to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>examples/tensorflow/object_detection
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
<span class="nb">cd</span><span class="w"> </span>ssd_mobilenet_v1/quantization/ptq
</pre></div>
</div>
</section>
<section id="install-protocol-buffer-compiler">
<h3>Install Protocol Buffer Compiler<a class="headerlink" href="#install-protocol-buffer-compiler" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Protocol</span> <span class="pre">Buffer</span> <span class="pre">Compiler</span></code> in version higher than 3.0.0 is necessary ingredient for automatic COCO dataset preparation. To install please follow
<a class="reference external" href="https://grpc.io/docs/protoc-installation/#install-using-a-package-manager">Protobuf installation instructions</a>.</p>
</section>
<section id="install-intel-extension-for-tensorflow">
<h3>Install Intel Extension for Tensorflow<a class="headerlink" href="#install-intel-extension-for-tensorflow" title="Link to this heading"></a></h3>
<section id="quantizing-the-model-on-intel-gpu-mandatory-to-install-itex">
<h4>Quantizing the model on Intel GPU(Mandatory to install ITEX)<a class="headerlink" href="#quantizing-the-model-on-intel-gpu-mandatory-to-install-itex" title="Link to this heading"></a></h4>
<p>Intel Extension for Tensorflow is mandatory to be installed for quantizing the model on Intel GPUs.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>intel-extension-for-tensorflow<span class="o">[</span>xpu<span class="o">]</span>
</pre></div>
</div>
<p>For any more details, please follow the procedure in <a class="reference external" href="https://github.com/intel/intel-extension-for-tensorflow/blob/main/docs/install/install_for_xpu.html#install-gpu-drivers">install-gpu-drivers</a></p>
</section>
<section id="quantizing-the-model-on-intel-cpu-optional-to-install-itex">
<h4>Quantizing the model on Intel CPU(Optional to install ITEX)<a class="headerlink" href="#quantizing-the-model-on-intel-cpu-optional-to-install-itex" title="Link to this heading"></a></h4>
<p>Intel Extension for Tensorflow for Intel CPUs is experimental currently. It’s not mandatory for quantizing the model on Intel CPUs.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>intel-extension-for-tensorflow<span class="o">[</span>cpu<span class="o">]</span>
</pre></div>
</div>
<blockquote>
<div><p><strong>Note</strong>:
The version compatibility of stock Tensorflow and ITEX can be checked <a class="reference external" href="https://github.com/intel/intel-extension-for-tensorflow#compatibility-table">here</a>. Please make sure you have installed compatible Tensorflow and ITEX.</p>
</div></blockquote>
</section>
</section>
</section>
<section id="prepare-model">
<h2>2. Prepare Model<a class="headerlink" href="#prepare-model" title="Link to this heading"></a></h2>
<section id="automated-approach">
<h3>Automated approach<a class="headerlink" href="#automated-approach" title="Link to this heading"></a></h3>
<p>Run the <code class="docutils literal notranslate"><span class="pre">prepare_model.py</span></code> script located in <code class="docutils literal notranslate"><span class="pre">examples/tensorflow/object_detection/ssd_mobilenet_v1/quantization/ptq</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">prepare_model</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">model_name</span><span class="o">=</span><span class="n">ssd_mobilenet_v1</span> <span class="o">--</span><span class="n">model_path</span><span class="o">=./</span>

<span class="n">Prepare</span> <span class="n">pre</span><span class="o">-</span><span class="n">trained</span> <span class="n">model</span> <span class="k">for</span> <span class="n">COCO</span> <span class="nb">object</span> <span class="n">detection</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">--</span><span class="n">model_name</span> <span class="p">{</span><span class="n">ssd_resnet50_v1</span><span class="p">,</span><span class="n">ssd_mobilenet_v1</span><span class="p">}</span>
                        <span class="n">model</span> <span class="n">to</span> <span class="n">download</span><span class="p">,</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">ssd_resnet50_v1</span>
  <span class="o">--</span><span class="n">model_path</span> <span class="n">MODEL_PATH</span>
                        <span class="n">directory</span> <span class="n">to</span> <span class="n">put</span> <span class="n">models</span><span class="p">,</span> <span class="n">default</span> <span class="ow">is</span> <span class="o">./</span><span class="n">model</span>
</pre></div>
</div>
</section>
<section id="manual-approach">
<h3>Manual approach<a class="headerlink" href="#manual-approach" title="Link to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget<span class="w"> </span>http://download.tensorflow.org/models/object_detection/ssd_mobilenet_v1_coco_2018_01_28.tar.gz
tar<span class="w"> </span>-xvzf<span class="w"> </span>ssd_mobilenet_v1_coco_2018_01_28.tar.gz
</pre></div>
</div>
</section>
</section>
<section id="prepare-dataset">
<h2>3. Prepare Dataset<a class="headerlink" href="#prepare-dataset" title="Link to this heading"></a></h2>
<section id="automatic-dataset-download">
<h3>Automatic dataset download<a class="headerlink" href="#automatic-dataset-download" title="Link to this heading"></a></h3>
<blockquote>
<div><p><strong><em>Note: <code class="docutils literal notranslate"><span class="pre">prepare_dataset.sh</span></code> script works with TF version 1.x.</em></strong></p>
</div></blockquote>
<p>Run the <code class="docutils literal notranslate"><span class="pre">prepare_dataset.sh</span></code> script located in <code class="docutils literal notranslate"><span class="pre">examples/tensorflow/object_detection</span></code>.</p>
<p>Usage:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>examples/tensorflow/object_detection
.<span class="w"> </span>prepare_dataset.sh
<span class="nb">cd</span><span class="w"> </span>ssd_mobilenet_v1/quantization/ptq
</pre></div>
</div>
<p>This script will download the <em>train</em>, <em>validation</em> and <em>test</em> COCO datasets. Furthermore it will convert them to
tensorflow records using the <code class="docutils literal notranslate"><span class="pre">https://github.com/tensorflow/models.git</span></code> dedicated script.</p>
</section>
<section id="manual-dataset-download">
<h3>Manual dataset download<a class="headerlink" href="#manual-dataset-download" title="Link to this heading"></a></h3>
<p>Download CoCo Dataset from <a class="reference external" href="https://cocodataset.org/#download">Official Website</a>.</p>
</section>
</section>
</section>
<section id="run-command">
<h1>Run Command<a class="headerlink" href="#run-command" title="Link to this heading"></a></h1>
<p>Now we support both pb and ckpt formats.</p>
<section id="quantization">
<h2>1. Quantization<a class="headerlink" href="#quantization" title="Link to this heading"></a></h2>
<section id="for-pb-format">
<h3>For PB format<a class="headerlink" href="#for-pb-format" title="Link to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>run_quant.sh<span class="w"> </span>--input_model<span class="o">=</span>./ssd_mobilenet_v1_coco_2018_01_28/frozen_inference_graph.pb<span class="w"> </span>--output_model<span class="o">=</span>./tensorflow-ssd_mobilenet_v1-tune.pb<span class="w"> </span>--dataset_location<span class="o">=</span>/path/to/dataset/coco_val.record
</pre></div>
</div>
</section>
<section id="for-ckpt-format">
<h3>For ckpt format<a class="headerlink" href="#for-ckpt-format" title="Link to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>run_quant.sh<span class="w"> </span>--input_model<span class="o">=</span>./ssd_mobilenet_v1_coco_2018_01_28/<span class="w"> </span>--output_model<span class="o">=</span>./tensorflow-ssd_mobilenet_v1-tune.pb<span class="w"> </span>--dataset_location<span class="o">=</span>/path/to/dataset/coco_val.record
</pre></div>
</div>
</section>
</section>
<section id="benchmark">
<h2>2. Benchmark<a class="headerlink" href="#benchmark" title="Link to this heading"></a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># run performance benchmark</span>
bash<span class="w"> </span>run_benchmark.sh<span class="w"> </span>--input_model<span class="o">=</span>./tensorflow-ssd_mobilenet_v1-tune.pb<span class="w">  </span>--dataset_location<span class="o">=</span>/path/to/dataset/coco_val.record<span class="w"> </span>--mode<span class="o">=</span>performance

<span class="c1"># run accuracy benchmark</span>
bash<span class="w"> </span>run_benchmark.sh<span class="w"> </span>--input_model<span class="o">=</span>./tensorflow-ssd_mobilenet_v1-tune.pb<span class="w">  </span>--dataset_location<span class="o">=</span>/path/to/dataset/coco_val.record<span class="w"> </span>--mode<span class="o">=</span>accuracy
</pre></div>
</div>
</section>
</section>
<section id="details-of-enabling-intel-neural-compressor-on-ssd-mobilenet-v1-for-tensorflow">
<h1>Details of enabling Intel® Neural Compressor on ssd_mobilenet_v1 for Tensorflow.<a class="headerlink" href="#details-of-enabling-intel-neural-compressor-on-ssd-mobilenet-v1-for-tensorflow" title="Link to this heading"></a></h1>
<p>This is a tutorial of how to enable ssd_mobilenet_v1 model with Intel® Neural Compressor.</p>
<section id="user-code-analysis">
<h2>User Code Analysis<a class="headerlink" href="#user-code-analysis" title="Link to this heading"></a></h2>
<p>User specifies fp32 <em>model</em>, calibration dataset <em>q_dataloader</em> and a custom <em>eval_func</em> which encapsulates the evaluation dataset and metric by itself.</p>
<p>For ssd_mobilenet_v1, we applied the latter one because our philosophy is to enable the model with minimal changes. Hence we need to make two changes on the original code. The first one is to implement the q_dataloader and make necessary changes to <em>eval_func</em>.</p>
<section id="code-update">
<h3>Code update<a class="headerlink" href="#code-update" title="Link to this heading"></a></h3>
<p>After prepare step is done, we just need update main.py like below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tune</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">neural_compressor.tensorflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">StaticQuantConfig</span><span class="p">,</span> <span class="n">quantize_model</span><span class="p">,</span> <span class="n">Model</span>

        <span class="n">quant_config</span> <span class="o">=</span> <span class="n">StaticQuantConfig</span><span class="p">(</span><span class="n">weight_granularity</span><span class="o">=</span><span class="s2">&quot;per_channel&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_graph</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">input_tensor_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;image_tensor&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">output_tensor_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;num_detections&quot;</span><span class="p">,</span> <span class="s2">&quot;detection_boxes&quot;</span><span class="p">,</span> <span class="s2">&quot;detection_scores&quot;</span><span class="p">,</span> <span class="s2">&quot;detection_classes&quot;</span><span class="p">]</span>
        <span class="n">q_model</span> <span class="o">=</span> <span class="n">quantize_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">quant_config</span><span class="p">,</span> <span class="n">calib_dataloader</span><span class="p">)</span>
        <span class="n">q_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_model</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">benchmark</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;performance&#39;</span><span class="p">:</span>
            <span class="n">evaluate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_graph</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_graph</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch size = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy: </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">accuracy</span><span class="p">)</span>
</pre></div>
</div>
<p>The quantization.fit() function will return a best quantized model during timeout constrain.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Intel® Neural Compressor, Intel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   <jinja2.runtime.BlockReference object at 0x7ff20da4f470> 
  <p></p><div><a href='https://www.intel.com/content/www/us/en/privacy/intel-cookie-notice.html' data-cookie-notice='true'>Cookies</a> <a href='https://www.intel.com/content/www/us/en/privacy/intel-privacy-notice.html'>| Privacy</a></div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>